2025-05-27 19:21:01,701 - VisualChainApp - INFO - main_orchestrator.main:147 - --- Starting Visual Chain Generation (Verification: DeepFace Multi-Model) ---
2025-05-27 19:21:01,701 - VisualChainApp - INFO - main_orchestrator.main:148 - Person A: Donald Trump
2025-05-27 19:21:01,701 - VisualChainApp - INFO - main_orchestrator.main:149 - Person B: Diddy
2025-05-27 19:21:01,701 - VisualChainApp - INFO - main_orchestrator.main:152 - --- Cleaning up previous output directories ---
2025-05-27 19:21:01,701 - VisualChainApp - INFO - main_orchestrator.clean_output_directory:81 - Cleaning contents of directory: output/connection_chain_images
2025-05-27 19:21:01,710 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:90 -   Deleted directory and its contents: output/connection_chain_images/The_late_Queen_Elizabeth_II_The_Archbishop_of_Canterbury
2025-05-27 19:21:01,712 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:90 -   Deleted directory and its contents: output/connection_chain_images/The_late_Queen_Elizabeth_II_Prince_William
2025-05-27 19:21:01,714 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:90 -   Deleted directory and its contents: output/connection_chain_images/Prince_Charles_Camilla,_Queen_Consort
2025-05-27 19:21:01,716 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:90 -   Deleted directory and its contents: output/connection_chain_images/The_late_Queen_Elizabeth_II_Sir_David_Attenborough
2025-05-27 19:21:01,718 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:90 -   Deleted directory and its contents: output/connection_chain_images/The_late_Queen_Elizabeth_II_Johnny_Depp
2025-05-27 19:21:01,721 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:90 -   Deleted directory and its contents: output/connection_chain_images/Pope_Francis_The_late_Queen_Elizabeth_II
2025-05-27 19:21:01,723 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:90 -   Deleted directory and its contents: output/connection_chain_images/Camilla,_Queen_Consort_Johnny_Depp
2025-05-27 19:21:01,725 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:90 -   Deleted directory and its contents: output/connection_chain_images/The_late_Queen_Elizabeth_II_Prince_Charles
2025-05-27 19:21:01,725 - VisualChainApp - INFO - main_orchestrator.clean_output_directory:93 - Finished cleaning directory: output/connection_chain_images
2025-05-27 19:21:01,725 - VisualChainApp - INFO - main_orchestrator.clean_output_directory:81 - Cleaning contents of directory: output/connection_chain_images_verified
2025-05-27 19:21:01,725 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:87 -   Deleted file/link: output/connection_chain_images_verified/03_Prince_Charles_to_Camilla,_Queen_Consort.jpg
2025-05-27 19:21:01,725 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:87 -   Deleted file/link: output/connection_chain_images_verified/01_Pope_Francis_to_The_late_Queen_Elizabeth_II.jpg
2025-05-27 19:21:01,726 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:87 -   Deleted file/link: output/connection_chain_images_verified/02_The_late_Queen_Elizabeth_II_to_Prince_Charles.jpg
2025-05-27 19:21:01,726 - VisualChainApp - INFO - main_orchestrator.clean_output_directory:93 - Finished cleaning directory: output/connection_chain_images_verified
2025-05-27 19:21:01,726 - VisualChainApp - INFO - main_orchestrator.clean_output_directory:81 - Cleaning contents of directory: output/temp_files
2025-05-27 19:21:01,726 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:87 -   Deleted file/link: output/temp_files/sub_chain_attempt_The_late_Queen_Elizabeth_II_to_Johnny_Depp_1.xml
2025-05-27 19:21:01,726 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:87 -   Deleted file/link: output/temp_files/sub_chain_attempt_Camilla,_Queen_Consort_to_Johnny_Depp_3.xml
2025-05-27 19:21:01,726 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:87 -   Deleted file/link: output/temp_files/sub_chain_attempt_Camilla,_Queen_Consort_to_Johnny_Depp_2.xml
2025-05-27 19:21:01,726 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:87 -   Deleted file/link: output/temp_files/sub_chain_attempt_Camilla,_Queen_Consort_to_Johnny_Depp_1.xml
2025-05-27 19:21:01,726 - VisualChainApp - DEBUG - main_orchestrator.clean_output_directory:87 -   Deleted file/link: output/temp_files/initial_full_chain_attempt_1.xml
2025-05-27 19:21:01,726 - VisualChainApp - INFO - main_orchestrator.clean_output_directory:93 - Finished cleaning directory: output/temp_files
2025-05-27 19:21:01,726 - VisualChainApp - DEBUG - main_orchestrator.load_prompt_template:96 - Attempting to load prompt template from: prompts/system_prompt.txt
2025-05-27 19:21:01,726 - VisualChainApp - INFO - main_orchestrator.load_prompt_template:100 - Prompt template loaded successfully from prompts/system_prompt.txt
2025-05-27 19:21:01,726 - VisualChainApp - DEBUG - main_orchestrator.load_prompt_template:96 - Attempting to load prompt template from: prompts/initial_user_input_template.xml
2025-05-27 19:21:01,727 - VisualChainApp - INFO - main_orchestrator.load_prompt_template:100 - Prompt template loaded successfully from prompts/initial_user_input_template.xml
2025-05-27 19:21:01,727 - VisualChainApp - DEBUG - main_orchestrator.load_prompt_template:96 - Attempting to load prompt template from: prompts/initial_chain_retry_user_input_template.xml
2025-05-27 19:21:01,727 - VisualChainApp - INFO - main_orchestrator.load_prompt_template:100 - Prompt template loaded successfully from prompts/initial_chain_retry_user_input_template.xml
2025-05-27 19:21:01,727 - VisualChainApp - DEBUG - main_orchestrator.load_prompt_template:96 - Attempting to load prompt template from: prompts/retry_user_input_template.xml
2025-05-27 19:21:01,727 - VisualChainApp - INFO - main_orchestrator.load_prompt_template:100 - Prompt template loaded successfully from prompts/retry_user_input_template.xml
2025-05-27 19:21:01,727 - VisualChainApp - DEBUG - main_orchestrator.load_prompt_template:96 - Attempting to load prompt template from: prompts/sub_chain_exclusion_instruction_template.txt
2025-05-27 19:21:01,728 - VisualChainApp - INFO - main_orchestrator.load_prompt_template:100 - Prompt template loaded successfully from prompts/sub_chain_exclusion_instruction_template.txt
2025-05-27 19:21:01,728 - VisualChainApp - INFO - main_orchestrator.main:178 - --- Step 1: Requesting Initial Full Connection Chain from Gemini ---
2025-05-27 19:21:01,728 - VisualChainApp - INFO - main_orchestrator.main:183 - Initial full chain generation attempt 1/2
2025-05-27 19:21:01,728 - VisualChainApp - INFO - initial_gemini_query.get_initial_chain:110 - Requesting chain: Donald Trump -> ... -> Diddy.
2025-05-27 19:21:01,728 - VisualChainApp - INFO - initial_gemini_query._load_gemini_task_header:13 - Gemini task header loaded from prompts/gemini_task_header.txt
2025-05-27 19:21:01,728 - VisualChainApp - INFO - initial_gemini_query.get_initial_chain_from_gemini_direct:50 - Querying Gemini with pre-formatted user input for a chain.
2025-05-27 19:21:01,728 - VisualChainApp - DEBUG - initial_gemini_query.get_initial_chain_from_gemini_direct:73 - User input XML for Gemini (part of full prompt):
## Task Execution
Now, using the rules, input format, and output formats defined above, please process the following connection request to find a full chain:<connection_request>
  <person1>Donald Trump</person1>
  <person2>Diddy</person2>
  <additional_instructions></additional_instructions> 
  <!-- This will be empty for the first call, or contain exclusion for sub-chain calls -->
</connection_request>
2025-05-27 19:21:01,728 - VisualChainApp - INFO - initial_gemini_query.get_initial_chain_from_gemini_direct:74 - --- Sending to Gemini (initial_gemini_query.get_initial_chain_from_gemini_direct) ---
2025-05-27 19:21:07,388 - VisualChainApp - DEBUG - initial_gemini_query.clean_gemini_xml_response:26 - Raw AI output before cleaning (first 300 chars): ```xml
<connection_chain>
  <chain_summary>
    <total_links>2</total_links>
    <subjects_connected>Donald Trump → Oprah Winfrey → Diddy</subjects_connected>
    <chain_type>Extended</chain_type>
    <intermediary_count>1</intermediary_count>
    <research_confidence>Medium</research_confidence>
  
2025-05-27 19:21:07,389 - VisualChainApp - DEBUG - initial_gemini_query.clean_gemini_xml_response:46 - AI output after cleaning (first 300 chars): <connection_chain>
  <chain_summary>
    <total_links>2</total_links>
    <subjects_connected>Donald Trump → Oprah Winfrey → Diddy</subjects_connected>
    <chain_type>Extended</chain_type>
    <intermediary_count>1</intermediary_count>
    <research_confidence>Medium</research_confidence>
  </chain
2025-05-27 19:21:07,390 - VisualChainApp - INFO - initial_gemini_query.get_initial_chain_from_gemini_direct:92 - Gemini response parsed as XML (root tag: connection_chain).
2025-05-27 19:21:07,390 - VisualChainApp - INFO - initial_gemini_query.get_initial_chain_from_gemini_direct:98 - Received response from Gemini.
2025-05-27 19:21:07,391 - VisualChainApp - INFO - main_orchestrator.main:211 - Initial full chain attempt 1 output saved to output/temp_files/initial_full_chain_attempt_1.xml
2025-05-27 19:21:07,391 - VisualChainApp - INFO - main_orchestrator.main:226 - Successfully parsed <connection_chain> on attempt 1.
2025-05-27 19:21:07,392 - VisualChainApp - INFO - main_orchestrator.main:262 - --- Processing Link 1/2 (Overall) ---
2025-05-27 19:21:07,392 - VisualChainApp - DEBUG - main_orchestrator.main:263 - Current link to process XML: <link id="1">
    <subjects>Donald Trump → Oprah Winfrey</subjects>
    <evidence>Both Donald Trump and Oprah Winfrey have appeared on various talk shows and television programs throughout their careers, and there are numerous instances of them being interviewed individually or on panels, though not
2025-05-27 19:21:07,392 - VisualChainApp - DEBUG - main_orchestrator.extract_persons_from_subjects:112 - Attempting to extract persons from subjects_text: 'Donald Trump → Oprah Winfrey'
2025-05-27 19:21:07,392 - VisualChainApp - DEBUG - main_orchestrator.extract_persons_from_subjects:133 - Extracted P1: 'Donald Trump', P2: 'Oprah Winfrey'
2025-05-27 19:21:07,392 - VisualChainApp - INFO - main_orchestrator.main:275 -   Attempting segment: 'Donald Trump' → 'Oprah Winfrey'
2025-05-27 19:21:07,393 - VisualChainApp - INFO - image_downloader.fetch_images_for_link:22 - Preparing to download images. Target: 'Donald Trump → Oprah Winfrey', Query: '"Donald Trump" AND "Oprah Winfrey"', Num: 5, Reference: False
2025-05-27 19:21:07,393 - VisualChainApp - INFO - image_downloader.fetch_images_for_link:43 - Created image download folder: output/connection_chain_images/Donald_Trump_Oprah_Winfrey
2025-05-27 19:21:07,393 - VisualChainApp - INFO - image_downloader.fetch_images_for_link:50 -   Saving up to 5 images to: output/connection_chain_images/Donald_Trump_Oprah_Winfrey for query: '"Donald Trump" AND "Oprah Winfrey"'
2025-05-27 19:21:07,396 - VisualChainApp - DEBUG - image_downloader.fetch_images_for_link:62 - Starting icrawler.crawl for: "Donald Trump" AND "Oprah Winfrey" (max_num=5)
2025-05-27 19:21:12,420 - VisualChainApp - INFO - image_downloader.fetch_images_for_link:70 -   Finished icrawler.crawl for 'Donald Trump → Oprah Winfrey'.
2025-05-27 19:21:12,421 - VisualChainApp - INFO - image_downloader.fetch_images_for_link:79 -   Found 0 image files in output/connection_chain_images/Donald_Trump_Oprah_Winfrey after crawl attempt.
2025-05-27 19:21:12,421 - VisualChainApp - WARNING - image_downloader.fetch_images_for_link:81 -   No new images appear to have been downloaded by icrawler for query: '"Donald Trump" AND "Oprah Winfrey"' for 'Donald Trump → Oprah Winfrey' despite requesting 5.
2025-05-27 19:21:12,422 - VisualChainApp - INFO - image_verifier.verify_and_potentially_reprompt_link:445 - --- Verifying link segment: 'Donald Trump' <-> 'Oprah Winfrey' (using DeepFace Multi-Model & Collage Check) ---
2025-05-27 19:21:12,422 - VisualChainApp - WARNING - image_verifier.verify_and_potentially_reprompt_link:452 -   No images found in the folder 'output/connection_chain_images/Donald_Trump_Oprah_Winfrey' to verify for 'Donald Trump' <-> 'Oprah Winfrey'.
2025-05-27 19:21:12,423 - VisualChainApp - INFO - image_verifier.verify_and_potentially_reprompt_link:456 -   Reprompting Gemini for an alternative link (due to no images).
2025-05-27 19:21:12,423 - VisualChainApp - INFO - image_verifier.query_gemini_text_for_retry:165 - Sending text prompt to Gemini for retry (from image_verifier)...
2025-05-27 19:21:12,423 - VisualChainApp - DEBUG - image_verifier.query_gemini_text_for_retry:167 - User part of prompt for Gemini text (verifier retry):
<retry_connection_request>
  <person1>Donald Trump</person1>
  <person2>Oprah Winfrey</person2>
  <failed_link_instruction>
    IMPORTANT: Your previous suggestion for a co-occurrence between Donald Trump and Oprah Winfrey (event: "Both Donald Trump and Oprah Winfrey have appeared on various talk shows and television programs throughout their careers, and there are numerous instances of them being interviewed individually or on panels, though not necessarily together in the same segment at the s
